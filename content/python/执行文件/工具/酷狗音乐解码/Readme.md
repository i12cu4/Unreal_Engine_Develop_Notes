# 酷狗音乐(KGM)文件解码技术说明

## 基本概念

酷狗音乐使用一种特殊的加密方式保护下载的音乐文件。每个文件有两个密钥：
- **私钥**：每个文件独有的16字节密钥
- **公钥**：所有酷狗文件共用的约70MB密钥

## 文件结构

```
酷狗加密文件 (.kgm/.kgm.flac):
├── 文件头 (1024字节)
│   ├── 魔数 (28字节) - 标识酷狗格式
│   ├── 私钥 (16字节，位于0x1c-0x2c)
│   └── 其他元数据
└── 加密的音频数据
```

## 解码算法步骤

### 1. 提取私钥
从文件头0x1c-0x2c位置读取16字节作为私钥。

### 2. 公钥系统
公钥保存在外部文件`kugou_key.xz`中，解压后约70MB。解密时需要这个公钥数据。

### 3. 核心解码公式

对于第`i`个字节（从0开始计数）：

```
设：
  E = 加密的字节
  O = 私钥[i % 17]
  P = 公钥[i / 16]
  M = 固定修正表[i % 272]
  
解码步骤：
1. 私钥处理: T1 = O ⊕ E
            T1 = T1 ⊕ ((T1 & 0x0F) << 4)
            
2. 公钥处理: T2 = M ⊕ P
            T2 = T2 ⊕ ((T2 & 0x0F) << 4)
            
3. 合并结果: D = T1 ⊕ T2
```

### 4. 关键操作解释

#### 异或操作 (⊕)
异或操作具有自反性：如果 `A ⊕ B = C`，那么 `C ⊕ B = A`。

#### 位移混淆
`value ⊕ ((value & 0x0F) << 4)` 操作：
1. 提取字节的低4位
2. 左移4位，放到高4位位置
3. 与原字节异或

这个操作是自逆的，两次操作后恢复原值。

## 具体例子

假设：
- 加密字节: `E = 0xAB` (二进制: 10101011)
- 私钥字节: `O = 0x12` (二进制: 00010010)
- 公钥字节: `P = 0x34` (二进制: 00110100)
- 修正表字节: `M = 0x56` (二进制: 01010110)

解码过程：

```
步骤1: 私钥处理
  T1 = 0xAB ⊕ 0x12 = 0xB9
  低4位: 0xB9 & 0x0F = 0x09
  左移4位: 0x09 << 4 = 0x90
  T1 = 0xB9 ⊕ 0x90 = 0x29

步骤2: 公钥处理
  T2 = 0x56 ⊕ 0x34 = 0x62
  低4位: 0x62 & 0x0F = 0x02
  左移4位: 0x02 << 4 = 0x20
  T2 = 0x62 ⊕ 0x20 = 0x42

步骤3: 合并结果
  D = 0x29 ⊕ 0x42 = 0x6B
```

解密后的字节是 `0x6B`。

## 周期特性

算法使用三个循环周期：

1. **私钥周期**: 17字节循环使用
   - 第0字节用私钥[0]，第1字节用私钥[1]，...，第16字节用私钥[0]

2. **公钥周期**: 每16个音频字节共享1个公钥字节
   - 字节0-15用公钥[0]，字节16-31用公钥[1]，依此类推

3. **修正表周期**: 272字节固定表循环使用
   - 第0字节用修正表[0]，第1字节用修正表[1]，...，第271字节用修正表[271]，第272字节用修正表[0]

## 算法特性

1. **位置相关**: 每个字节的解码结果取决于它在文件中的位置
2. **对称性**: 加密和解密使用相同的算法
3. **流式处理**: 可以实时解码，无需加载整个文件
4. **双重保护**: 需要同时拥有私钥和公钥才能正确解码
5. **一源多密**: 同一音频数据使用不同私钥加密会得到不同的加密文件

## 重要特性：一源多密

酷狗加密算法具有一个关键特性：**同一份原始音频数据使用不同私钥加密，会生成完全不同的加密文件，但这些文件都能正确解密出相同的原始音频**。

### 这种现象的原因：

1. **私钥的唯一性**：每个加密文件都包含一个独特的16字节私钥，存储在文件头中
2. **算法的独立性**：加密算法中，私钥与音频数据的每个字节都进行独立的异或操作
3. **异或运算的特性**：相同的音频字节与不同的私钥字节异或，必然产生不同的结果

### 实际表现示例：

```
原始音频数据： [A, B, C, D, E]
私钥A：        [K1, K2, K3, K4, K5]
私钥B：        [J1, J2, J3, J4, J5]

使用私钥A加密：
加密文件A = [A⊕K1, B⊕K2, C⊕K3, D⊕K4, E⊕K5]

使用私钥B加密：
加密文件B = [A⊕J1, B⊕J2, C⊕J3, D⊕J4, E⊕J5]

文件A ≠ 文件B（字节完全不同）
```

### 对用户的影响：

1. **不可通过字节对比判断文件来源**：两个不同的.kgm文件可能是同一首歌曲的不同加密版本
2. **不影响播放质量**：只要使用正确的公钥和对应私钥，都能解密出相同的原始音频
3. **版权追踪功能**：酷狗可通过私钥唯一性追踪文件的下载来源和分发路径
4. **验证算法正确性**：这是验证解码/编码程序正确性的重要特征

### 验证方法：

要验证解码算法的正确性，可以进行以下测试：
1. 下载一个酷狗加密文件，提取其私钥
2. 使用该私钥重新加密解密后的音频
3. 对比重新加密的文件与原始文件
4. 如果两者字节完全相同，说明算法完全正确
5. 如果使用不同私钥重新加密，应得到不同文件但能解密出相同音频

## 实际实现考虑

在实现解码器时需要注意：

1. **公钥加载**: 公钥文件约70MB，建议使用惰性加载或内存映射
2. **性能优化**: 循环内避免重复计算模运算
3. **错误处理**: 检查文件格式和密钥完整性
4. **内存管理**: 处理大文件时的内存使用

## 验证解码正确性

解码后应该得到标准的音频格式数据，如：
- MP3文件以`0xFFFB`或`ID3`开头
- FLAC文件以`fLaC`开头
- WAV文件以`RIFF`开头

如果解码后的文件无法播放，可能原因：
1. 公钥文件不正确
2. 输入文件不是有效的酷狗加密文件
3. 文件头已损坏

这个解码算法成功逆向工程了酷狗的加密系统，使得加密的音乐文件可以转换为标准的音频格式。